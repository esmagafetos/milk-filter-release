name: Build Debug APK (test)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Find gradlew
        id: findgradle
        run: |
          # Prefer root gradlew
          if [ -f "./gradlew" ]; then
            echo "path=." >> $GITHUB_OUTPUT
          else
            # Search for gradlew in subdirectories
            f=$(find . -maxdepth 6 -type f -name gradlew -print -quit || true)
            if [ -n "$f" ]; then
              d=$(dirname "$f")
              echo "path=${d}" >> $GITHUB_OUTPUT
            else
              echo "path=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Ensure gradlew is executable (if found)
        run: |
          if [ -n "${{ steps.findgradle.outputs.path }}" ] && [ -f "${{ steps.findgradle.outputs.path }}/gradlew" ]; then
            chmod +x "${{ steps.findgradle.outputs.path }}/gradlew"
            echo "Made ${ { steps.findgradle.outputs.path } }/gradlew executable" || true
          else
            echo "No gradlew found"
          fi

      - name: Build Debug APK (if gradle wrapper exists)
        run: |
          set -euo pipefail
          if [ -n "${{ steps.findgradle.outputs.path }}" ] && [ -f "${{ steps.findgradle.outputs.path }}/gradlew" ]; then
            cd "${{ steps.findgradle.outputs.path }}"
            ./gradlew --no-daemon assembleDebug
          else
            echo "Skipping build: no gradlew found in repository"
          fi

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: |
            **/build/outputs/**/*.apk
